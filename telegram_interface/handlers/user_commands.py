# telegram_interface/handlers/user_commands.py

import logging
from aiogram import Router, types
from aiogram.filters import Command, CommandStart

# --- Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ ---
try:
    from utils.helpers import escape_markdown_v2
    # Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ AI, Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ´Ñ€Ğ¾:
    # from core_agent.agent_processor import handle_user_request
    # Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ Ğ‘Ğ” (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, /my_notes):
    # import database
except ImportError:
    logging.critical("CRITICAL: Failed to import dependencies in user_commands!", exc_info=True)
    def escape_markdown_v2(text: str) -> str: return text

logger = logging.getLogger(__name__)
router = Router(name="user_commands_router")

@router.message(CommandStart())
async def handle_start(message: types.Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start."""
    user = message.from_user
    if not user: return # ĞĞ° Ğ²ÑÑĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹

    user_name = user.full_name
    await message.reply(
        f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {escape_markdown_v2(user_name)}\\! ğŸ‘‹\n"
        "Ğ¯ Ñ‚Ğ²Ğ¾Ğ¹ AI-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚\\. Ğ§ĞµĞ¼ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ?\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ /help, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ¾ Ğ¼Ğ¾Ğ¸Ñ… Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑÑ…\\."
    )
    # --- ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ‘Ğ” ---
    # try:
    #     import database # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ, ĞµÑĞ»Ğ¸ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
    #     if database:
    #         await database.upsert_user_profile(
    #             user_id=user.id,
    #             username=user.username,
    #             first_name=user.first_name,
    #             last_name=user.last_name
    #         )
    # except Exception as e:
    #      logger.error(f"Failed to upsert profile for user {user.id} on /start: {e}", exc_info=True)

@router.message(Command("help"))
async def handle_help(message: types.Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /help."""
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸, ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸
    help_text = """
*ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸:*
- ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¼Ğ½Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ, Ğ¸ Ñ Ğ¿Ğ¾ÑÑ‚Ğ°Ñ€Ğ°ÑÑÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ.
- Ğ’ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ñ Ğ½Ğ° ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ (`@Ğ¸Ğ¼Ñ_Ğ±Ğ¾Ñ‚Ğ°`) Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ¼Ğ¾Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.
- ĞœĞ¾Ğ³Ñƒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ ĞºĞ¾Ğ´ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¼ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¸ (ÑĞ¿Ñ€Ğ¾ÑˆÑƒ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹).
- Ğ£Ğ·Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ, ĞºÑƒÑ€ÑÑ‹ Ğ°ĞºÑ†Ğ¸Ğ¹ (ÑĞ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ğ¼ĞµĞ½Ñ).
- ĞœĞ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ€Ñ‚ Ğ¯Ğ½Ğ´ĞµĞºÑ.ĞœÑƒĞ·Ñ‹ĞºĞ¸ (/charts).
- ĞŸĞ¾Ğ¼Ğ¾Ğ³Ñƒ Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğµ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Deep Search).
- Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ñ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ±ÑƒĞ´Ñƒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°Ñ Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ…, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ.
- ĞœĞ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.

*Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:*
/start - ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³
/help - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ

*ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹* (Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼ Ğ±Ğ¾Ñ‚Ğ°):
`/warn`, `/unwarn`, `/warns` - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ÑĞ¼Ğ¸
`/ban`, `/unban` - Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ°/Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
`/del` - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼)
`/stats` - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
`/clear` - ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ñ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ (Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ) Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
`/set_prompt` - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ (Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼)
`/reset_prompt` - Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚
`/set_ai [pro/default]` - Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼ AI (Pro Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)
`/set_model [Ğ¸Ğ¼Ñ_Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸]` - Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Gemini
`/news_setup` - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ¸Ğ½Ğ³ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹
"""
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ· Markdown, Ñ‚.Ğº. Ñ‚ĞµĞºÑÑ‚ ÑƒĞ¶Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    await message.reply(help_text, parse_mode="None")

# --- Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑÑĞ´Ğ° ---
# ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€:
# @router.message(Command("my_notes"))
# async def handle_my_notes(message: types.Message):
#     """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
#     if database is None: await message.reply("âŒ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°."); return
#     user_id = message.from_user.id
#     notes = await database.get_user_notes(user_id, parse_json=False) # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğº ÑÑ‚Ñ€Ğ¾ĞºĞ¸
#     if not notes:
#         await message.reply("Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº.")
#         return
#     response_lines = ["*Ğ’Ğ°ÑˆĞ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸:*"]
#     for category, value in notes.items():
#         response_lines.append(f"- *{escape_markdown_v2(category)}*: {escape_markdown_v2(value[:100])}{'...' if len(value)>100 else ''}")
#     await message.reply("\n".join(response_lines))